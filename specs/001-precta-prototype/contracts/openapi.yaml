openapi: 3.1.0
info:
  title: Precta Healthcare Platform API
  version: 1.0.0
  description: |
    Kenya-focused healthcare platform API for patients, doctors, and administrators.
    
    ## Authentication
    All authenticated endpoints require a Bearer token in the Authorization header.
    Tokens are obtained via the `/api/v1/auth/login` endpoint.
    
    ## Rate Limiting
    - Standard endpoints: 100 requests/minute
    - Auth endpoints: 10 requests/minute
    
    ## Response Format
    All responses follow the structure:
    ```json
    {
      "data": {...},
      "meta": {"timestamp": "...", "requestId": "..."}
    }
    ```
    
    Errors follow:
    ```json
    {
      "error": {
        "code": "ERROR_CODE",
        "message": "Human readable message",
        "details": {...}
      }
    }
    ```
  contact:
    name: Precta Support
    email: support@precta.co.ke
  license:
    name: Proprietary

servers:
  - url: http://localhost:3001/api/v1
    description: Local development
  - url: https://api.precta.co.ke/api/v1
    description: Production

tags:
  - name: Auth
    description: Authentication endpoints
  - name: Doctors
    description: Doctor search and profiles
  - name: Appointments
    description: Appointment booking
  - name: Consultations
    description: Video consultations
  - name: Records
    description: Medical records
  - name: Prescriptions
    description: Digital prescriptions
  - name: Orders
    description: Medicine orders
  - name: Articles
    description: Health content
  - name: Reviews
    description: Doctor reviews
  - name: Admin
    description: Admin operations

paths:
  # ============ AUTH ============
  /auth/register:
    post:
      tags: [Auth]
      summary: Register new user
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Email or phone already exists

  /auth/login:
    post:
      tags: [Auth]
      summary: Login user
      operationId: loginUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/logout:
    post:
      tags: [Auth]
      summary: Logout user
      operationId: logoutUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful

  /auth/me:
    get:
      tags: [Auth]
      summary: Get current user
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ============ DOCTORS ============
  /doctors:
    get:
      tags: [Doctors]
      summary: Search doctors
      operationId: searchDoctors
      parameters:
        - name: q
          in: query
          description: Search query (name, specialty)
          schema:
            type: string
        - name: specialty
          in: query
          description: Filter by specialty
          schema:
            type: string
        - name: city
          in: query
          description: Filter by city
          schema:
            type: string
        - name: consultation_type
          in: query
          description: Filter by consultation type
          schema:
            type: string
            enum: [in_person, video]
        - name: min_rating
          in: query
          description: Minimum rating (1-5)
          schema:
            type: number
            minimum: 1
            maximum: 5
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: List of doctors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DoctorListResponse'

  /doctors/{id}:
    get:
      tags: [Doctors]
      summary: Get doctor profile
      operationId: getDoctorProfile
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Doctor profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DoctorProfile'
        '404':
          $ref: '#/components/responses/NotFound'

  /doctors/{id}/availability:
    get:
      tags: [Doctors]
      summary: Get doctor availability
      operationId: getDoctorAvailability
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: date
          in: query
          description: Date to check (YYYY-MM-DD)
          required: true
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Available slots
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AvailabilityResponse'

  /doctors/{id}/reviews:
    get:
      tags: [Doctors, Reviews]
      summary: Get doctor reviews
      operationId: getDoctorReviews
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: List of reviews
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewListResponse'

  # ============ APPOINTMENTS ============
  /appointments:
    get:
      tags: [Appointments]
      summary: List user appointments
      operationId: listAppointments
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending_payment, confirmed, completed, cancelled]
        - name: page
          in: query
          schema:
            type: integer
            default: 1
      responses:
        '200':
          description: List of appointments
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppointmentListResponse'
    
    post:
      tags: [Appointments]
      summary: Book appointment
      operationId: bookAppointment
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BookAppointmentRequest'
      responses:
        '201':
          description: Appointment booked (pending payment)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppointmentWithPayment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Slot no longer available

  /appointments/{id}:
    get:
      tags: [Appointments]
      summary: Get appointment details
      operationId: getAppointment
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Appointment details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Appointment'
        '404':
          $ref: '#/components/responses/NotFound'

  /appointments/{id}/cancel:
    post:
      tags: [Appointments]
      summary: Cancel appointment
      operationId: cancelAppointment
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
      responses:
        '200':
          description: Appointment cancelled

  # ============ CONSULTATIONS ============
  /consultations/{appointmentId}/join:
    post:
      tags: [Consultations]
      summary: Join video consultation
      operationId: joinConsultation
      security:
        - bearerAuth: []
      parameters:
        - name: appointmentId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Video room token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConsultationJoinResponse'
        '400':
          description: Appointment not ready for consultation

  /consultations/{id}:
    get:
      tags: [Consultations]
      summary: Get consultation record
      operationId: getConsultation
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Consultation record
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Consultation'

    patch:
      tags: [Consultations]
      summary: Update consultation (doctor notes)
      operationId: updateConsultation
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateConsultationRequest'
      responses:
        '200':
          description: Consultation updated

  # ============ RECORDS ============
  /records:
    get:
      tags: [Records]
      summary: List medical records
      operationId: listRecords
      security:
        - bearerAuth: []
      parameters:
        - name: type
          in: query
          schema:
            type: string
            enum: [prescription, lab_result, imaging, consultation_note, other]
      responses:
        '200':
          description: List of records
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecordListResponse'

    post:
      tags: [Records]
      summary: Upload medical record
      operationId: uploadRecord
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file, type, name]
              properties:
                file:
                  type: string
                  format: binary
                type:
                  type: string
                  enum: [prescription, lab_result, imaging, consultation_note, other]
                name:
                  type: string
                description:
                  type: string
      responses:
        '201':
          description: Record uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MedicalRecord'

  # ============ PRESCRIPTIONS ============
  /prescriptions:
    post:
      tags: [Prescriptions]
      summary: Create prescription (doctor only)
      operationId: createPrescription
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePrescriptionRequest'
      responses:
        '201':
          description: Prescription created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Prescription'

  /prescriptions/{id}:
    get:
      tags: [Prescriptions]
      summary: Get prescription
      operationId: getPrescription
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Prescription details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Prescription'

  # ============ ORDERS ============
  /orders:
    get:
      tags: [Orders]
      summary: List orders
      operationId: listOrders
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of orders
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderListResponse'

    post:
      tags: [Orders]
      summary: Create medicine order
      operationId: createOrder
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
      responses:
        '201':
          description: Order created (pending payment)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderWithPayment'

  /orders/{id}:
    get:
      tags: [Orders]
      summary: Get order details
      operationId: getOrder
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Order details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'

  # ============ ARTICLES ============
  /articles:
    get:
      tags: [Articles]
      summary: List articles
      operationId: listArticles
      parameters:
        - name: category
          in: query
          schema:
            type: string
        - name: q
          in: query
          description: Search query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
      responses:
        '200':
          description: List of articles
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArticleListResponse'

  /articles/{slug}:
    get:
      tags: [Articles]
      summary: Get article by slug
      operationId: getArticle
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Article content
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Article'

  # ============ REVIEWS ============
  /reviews:
    post:
      tags: [Reviews]
      summary: Submit review
      operationId: submitReview
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateReviewRequest'
      responses:
        '201':
          description: Review submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'

  # ============ PAYMENTS ============
  /payments/initialize:
    post:
      tags: [Payments]
      summary: Initialize payment
      operationId: initializePayment
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InitializePaymentRequest'
      responses:
        '200':
          description: Payment initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentInitResponse'

  /payments/webhook:
    post:
      tags: [Payments]
      summary: Paystack webhook
      operationId: paystackWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook processed

  # ============ ADMIN ============
  /admin/doctors/pending:
    get:
      tags: [Admin]
      summary: List pending doctor verifications
      operationId: listPendingVerifications
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of pending doctors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DoctorListResponse'

  /admin/doctors/{id}/verify:
    post:
      tags: [Admin]
      summary: Verify doctor
      operationId: verifyDoctor
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyDoctorRequest'
      responses:
        '200':
          description: Doctor verification updated

  /admin/analytics:
    get:
      tags: [Admin]
      summary: Get platform analytics
      operationId: getAnalytics
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Analytics data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    Error:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object

    RegisterRequest:
      type: object
      required: [email, password, role]
      properties:
        email:
          type: string
          format: email
        phone:
          type: string
        password:
          type: string
          minLength: 8
        role:
          type: string
          enum: [patient, doctor]
        first_name:
          type: string
        last_name:
          type: string

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    AuthResponse:
      type: object
      properties:
        user:
          $ref: '#/components/schemas/User'
        token:
          type: string

    User:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
        phone:
          type: string
        role:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time

    DoctorProfile:
      type: object
      properties:
        id:
          type: string
        first_name:
          type: string
        last_name:
          type: string
        bio:
          type: string
        profile_image_url:
          type: string
        specialties:
          type: array
          items:
            type: string
        languages:
          type: array
          items:
            type: string
        consultation_fee:
          type: number
        consultation_modes:
          type: array
          items:
            type: string
        average_rating:
          type: number
        total_reviews:
          type: integer
        verification_status:
          type: string

    DoctorListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/DoctorProfile'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    AvailabilityResponse:
      type: object
      properties:
        date:
          type: string
          format: date
        slots:
          type: array
          items:
            type: object
            properties:
              time:
                type: string
                format: time
              available:
                type: boolean
              consultation_type:
                type: string

    BookAppointmentRequest:
      type: object
      required: [doctor_id, scheduled_at, consultation_type]
      properties:
        doctor_id:
          type: string
        scheduled_at:
          type: string
          format: date-time
        consultation_type:
          type: string
          enum: [in_person, video]
        notes:
          type: string

    Appointment:
      type: object
      properties:
        id:
          type: string
        patient_id:
          type: string
        doctor_id:
          type: string
        scheduled_at:
          type: string
          format: date-time
        consultation_type:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time

    AppointmentWithPayment:
      allOf:
        - $ref: '#/components/schemas/Appointment'
        - type: object
          properties:
            payment_url:
              type: string

    AppointmentListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Appointment'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    ConsultationJoinResponse:
      type: object
      properties:
        room_id:
          type: string
        token:
          type: string
        app_id:
          type: string

    Consultation:
      type: object
      properties:
        id:
          type: string
        appointment_id:
          type: string
        started_at:
          type: string
          format: date-time
        ended_at:
          type: string
          format: date-time
        duration_seconds:
          type: integer
        doctor_notes:
          type: string
        diagnosis:
          type: string

    UpdateConsultationRequest:
      type: object
      properties:
        doctor_notes:
          type: string
        diagnosis:
          type: string
        follow_up_recommended:
          type: boolean
        follow_up_notes:
          type: string

    MedicalRecord:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
        name:
          type: string
        description:
          type: string
        file_url:
          type: string
        uploaded_at:
          type: string
          format: date-time

    RecordListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/MedicalRecord'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    CreatePrescriptionRequest:
      type: object
      required: [patient_id, medications]
      properties:
        consultation_id:
          type: string
        patient_id:
          type: string
        medications:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              dosage:
                type: string
              frequency:
                type: string
              duration:
                type: string
              instructions:
                type: string
        instructions:
          type: string
        valid_until:
          type: string
          format: date

    Prescription:
      type: object
      properties:
        id:
          type: string
        patient_id:
          type: string
        doctor_id:
          type: string
        medications:
          type: array
          items:
            type: object
        instructions:
          type: string
        issued_at:
          type: string
          format: date-time

    CreateOrderRequest:
      type: object
      required: [items, delivery_address]
      properties:
        prescription_id:
          type: string
        items:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              quantity:
                type: integer
              unit_price:
                type: number
        delivery_address:
          type: string
        delivery_notes:
          type: string

    Order:
      type: object
      properties:
        id:
          type: string
        status:
          type: string
        items:
          type: array
          items:
            type: object
        total_amount:
          type: number
        created_at:
          type: string
          format: date-time

    OrderWithPayment:
      allOf:
        - $ref: '#/components/schemas/Order'
        - type: object
          properties:
            payment_url:
              type: string

    OrderListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Order'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    Article:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        slug:
          type: string
        excerpt:
          type: string
        body:
          type: string
        category:
          type: string
        featured_image_url:
          type: string
        published_at:
          type: string
          format: date-time

    ArticleListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Article'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    CreateReviewRequest:
      type: object
      required: [doctor_id, rating]
      properties:
        doctor_id:
          type: string
        consultation_id:
          type: string
        rating:
          type: integer
          minimum: 1
          maximum: 5
        comment:
          type: string

    Review:
      type: object
      properties:
        id:
          type: string
        patient_id:
          type: string
        doctor_id:
          type: string
        rating:
          type: integer
        comment:
          type: string
        created_at:
          type: string
          format: date-time

    ReviewListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Review'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    InitializePaymentRequest:
      type: object
      required: [type, reference_id]
      properties:
        type:
          type: string
          enum: [appointment, order]
        reference_id:
          type: string
        method:
          type: string
          enum: [mpesa, card]

    PaymentInitResponse:
      type: object
      properties:
        authorization_url:
          type: string
        access_code:
          type: string
        reference:
          type: string

    VerifyDoctorRequest:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [verified, rejected]
        notes:
          type: string

    AnalyticsResponse:
      type: object
      properties:
        total_patients:
          type: integer
        total_doctors:
          type: integer
        total_appointments:
          type: integer
        total_revenue:
          type: number
        appointments_by_day:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
              count:
                type: integer

    PaginationMeta:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        total_pages:
          type: integer
